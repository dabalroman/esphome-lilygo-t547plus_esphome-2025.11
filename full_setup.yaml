esphome:
  name: lilygo
  friendly_name: lilygo e-ink display

  platformio_options:
    upload_speed: 921600
    monitor_speed: 115200
    board_build.mcu: esp32s3
    board_build.f_cpu: 240000000L
    board_build.arduino.memory_type: qspi_opi
    board_build.flash_size: 4MB
    board_build.flash_mode: qio
    board_build.flash_type: qspi
    board_build.psram_type: opi
    board_build.memory_type: qspi_opi
    board_build.boot_freq: 80m
    build_flags:
      - "-DBOARD_HAS_PSRAM"
      - "-DARDUINO_USB_CDC_ON_BOOT=1"
      - "-mfix-esp32-psram-cache-issue"

  libraries:
    - SPI

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino
    # CRITICAL for ESP-IDF 5.4.2+: Enable PSRAM initialization (thanks @hbast!)
    sdkconfig_options:
      CONFIG_SPIRAM: "y"
      CONFIG_SPIRAM_MODE_OCT: "y"
      CONFIG_SPIRAM_SPEED_80M: "y"
      CONFIG_SPIRAM_USE_MALLOC: "y"
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "16384"
      CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP: "y"
      CONFIG_ESP32S3_SPIRAM_SUPPORT: "y"
      CONFIG_SPIRAM_BOOT_INIT: "y"
      CONFIG_SPIRAM_IGNORE_NOTFOUND: "n"

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "uji41VdMORB5966gRlVYEbBaC5LU9NZwHStB8j2d/nU="

ota:
  - platform: esphome
    password: "4ab30fdd89bd61087359d5eebf85d296"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Lilygo Fallback Hotspot"
    password: "zYQIOsSr8spF"

captive_portal:

external_components:
  - source: github://dabalroman/esphome-lilygo-t547plus_esphome-2025.11
    components: ["t547"]

time:
  - platform: homeassistant
    id: ha_time

font:
  - file: "gfonts://Roboto"
    id: font_title
    size: 52

  - file: "gfonts://Roboto"
    id: font_label
    size: 28

  - file: "gfonts://Roboto Mono"
    id: font_small
    size: 22

  - file: "gfonts://Roboto Mono"
    id: font_clock
    size: 72

display:
  - platform: t547
    id: my_display
    rotation: 180
    update_interval: 30s    # good compromise for clock + e-ink
    lambda: |-
      const int w = it.get_width();   // 960
      const int h = it.get_height();  // 540

      it.fill(COLOR_OFF);

      // === TOP BANNER ======================================================
      it.filled_rectangle(0, 0, w, 80, COLOR_ON);
      it.printf(w / 2, 28, id(font_title), TextAlign::CENTER, "T547 DIAGNOSTIC DEMO");
      it.printf(w / 2, 60, id(font_small), TextAlign::CENTER, "Shapes  |  Text  |  Time from Home Assistant");

      // === MAIN AREA FRAME & LIGHT GRID ===================================
      const int area_x = 30;
      const int area_y = 90;
      const int area_w = w - 60;
      const int area_h = h - 150;

      // Light grid in background
      for (int x = area_x; x <= area_x + area_w; x += 60) {
        it.line(x, area_y, x, area_y + area_h, COLOR_ON);
      }
      for (int y = area_y; y <= area_y + area_h; y += 50) {
        it.line(area_x, y, area_x + area_w, y, COLOR_ON);
      }

      // Clear main area and frame it
      it.filled_rectangle(area_x + 1, area_y + 1, area_w - 2, area_h - 2, COLOR_OFF);
      it.rectangle(area_x, area_y, area_w, area_h, COLOR_ON);

      // === LEFT COLUMN: CIRCLES ============================================
      int left_cx = area_x + 150;
      int left_cy = area_y + 130;
      it.printf(left_cx, area_y + 10, id(font_label), TextAlign::CENTER, "Circles");
      it.circle(left_cx, left_cy, 70, COLOR_ON);           // outline
      it.filled_circle(left_cx, left_cy, 40, COLOR_ON);    // filled core

      // Small ring
      it.circle(left_cx - 80, left_cy + 80, 20, COLOR_ON);
      it.circle(left_cx + 80, left_cy + 80, 20, COLOR_ON);

      it.printf(left_cx, left_cy + 120, id(font_small), TextAlign::CENTER, "Outline + filled + rings");

      // === CENTER COLUMN: CLOCK + DATE =====================================
      int center_x = area_x + area_w / 2;
      int center_y = area_y + 40;
      it.printf(center_x, center_y, id(font_label), TextAlign::CENTER, "Time");

      // Big clock and date from HA
      center_y += 45;
      if (id(ha_time).now().is_valid()) {
        it.strftime(center_x, center_y + 30, id(font_clock), TextAlign::CENTER,
                    "%H:%M:%S", id(ha_time).now());
        it.strftime(center_x, center_y + 90, id(font_small), TextAlign::CENTER,
                    "%Y-%m-%d", id(ha_time).now());
      } else {
        it.printf(center_x, center_y + 40, id(font_small), TextAlign::CENTER,
                  "Waiting for Home Assistant time...");
      }

      // Label line under clock
      it.printf(center_x, center_y + 130, id(font_small), TextAlign::CENTER,
                "Source: time.homeassistant");

      // === RIGHT COLUMN: LINES / TRIANGLE / HATCH ==========================
      int right_x = area_x + area_w - 180;
      int right_y = area_y + 10;
      it.printf(right_x, right_y, id(font_label), TextAlign::CENTER, "Lines");

      right_y += 40;

      // Triangle
      int tx = right_x;
      int ty = right_y + 10;
      int t_base_y = ty + 80;
      int t_left_x = tx - 70;
      int t_right_x = tx + 70;
      it.line(t_left_x, t_base_y, t_right_x, t_base_y, COLOR_ON);
      it.line(t_left_x, t_base_y, tx, ty, COLOR_ON);
      it.line(t_right_x, t_base_y, tx, ty, COLOR_ON);

      // Hatched box
      int box_x = right_x - 90;
      int box_y = t_base_y + 30;
      int box_w = 180;
      int box_h = 70;
      it.rectangle(box_x, box_y, box_w, box_h, COLOR_ON);

      for (int d = -20; d < box_w + box_h; d += 6) {
        int sx = box_x + d;
        int sy = box_y;
        int ex = box_x;
        int ey = box_y + d;

        if (sx < box_x) {
          sy += (box_x - sx);
          sx = box_x;
        }
        if (ey < box_y) {
          ex += (box_y - ey);
          ey = box_y;
        }
        if (sx <= box_x + box_w && ey <= box_y + box_h) {
          it.line(sx, sy, ex, ey, COLOR_ON);
        }
      }

      it.printf(right_x, box_y + box_h + 10, id(font_small), TextAlign::CENTER,
                "Triangle, diagonals, hatching");

      // === BOTTOM BAR =======================================================
      it.filled_rectangle(0, h - 40, w, 40, COLOR_ON);
      it.printf(10, h - 20, id(font_small), TextAlign::TOP_LEFT,
                "ESPHome + T547 driver demo");
      it.printf(w - 10, h - 20, id(font_small), TextAlign::TOP_RIGHT,
                "Shapes + Text + Time OK");
